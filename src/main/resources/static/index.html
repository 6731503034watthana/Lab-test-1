<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>บันทึกนักเรียน ม.4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f7f7fb; --card:#fff; --line:#e6e6ef; --text:#222; --muted:#666; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 960px; margin: 32px auto; padding: 0 16px; }
    .title { font-size: 28px; font-weight: 700; margin-bottom: 16px; }
    .card { background: var(--card); border:1px solid var(--line); border-radius: 14px; padding: 20px; box-shadow: 0 4px 16px rgba(0,0,0,.04); }
    form { display: grid; gap: 14px; grid-template-columns: 1fr; }
    @media (min-width: 720px) { form { grid-template-columns: 1fr 1fr; } .full { grid-column: 1 / -1; } }
    label { font-size: 13px; color: var(--muted); display:block; margin-bottom:6px; }
    input, select { width: 100%; padding: 10px 12px; border:1px solid var(--line); border-radius: 10px; background:#fff; font-size: 15px; }
    input[readonly] { background:#fafafa; color:#999; }
    .row { display:flex; gap:10px; }
    .btn { appearance: none; border:0; background:#1a73e8; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#f0f3f8; color:#234; }
    .toolbar { display:flex; gap:10px; }
    table { width:100%; border-collapse: collapse; margin-top: 14px; }
    th, td { padding: 10px 12px; border-bottom:1px solid var(--line); text-align:left; font-size: 14px; }
    th { color:#3a3a46; }
    .chip { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; background:#eef4ff; border:1px solid #d9e6ff; }
    .actions button { margin-right:8px; }
    .muted { color: var(--muted); font-size: 13px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">บันทึกนักเรียน ม.4</div>

    <div class="card" style="margin-bottom:18px">
      <form id="f">
        <div class="field">
          <label>ชื่อ</label>
          <input id="firstName" required placeholder="เช่น ปวิช">
        </div>
        <div class="field">
          <label>นามสกุล</label>
          <input id="lastName" required placeholder="เช่น สุขใจ">
        </div>

        <div class="field">
          <label>สาขาวิชา</label>
          <select id="major" required>
            <option value="" disabled selected>เลือกสาขา</option>
            <option value="SCI_MATH">วิทย์คณิต</option>
            <option value="MATH_ENGLISH">คณิตอังกฤษ</option>
            <option value="GENERAL">ทั่วไป</option>
          </select>
        </div>

        <div class="field">
          <label>เกรด (0.00–4.00)</label>
          <input id="grade" type="number" min="0" max="4" step="0.01" required>
        </div>

        <div class="field">
          <label>ระดับชั้น</label>
          <input id="level" value="ม.4" readonly>
        </div>

        <div class="field toolbar full">
          <input type="hidden" id="id">
          <button class="btn" type="submit">บันทึก</button>
          <button class="btn secondary" type="button" id="clear">ล้างฟอร์ม</button>
          <span class="muted">API: <code>/api/students</code></span>
        </div>
      </form>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>ชื่อ</th>
            <th>นามสกุล</th>
            <th>สาขา</th>
            <th>ระดับ</th>
            <th>เกรด</th>
            <th>จัดการ</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>

  <script>
    const api = '/api/students';
    const tb = document.getElementById('tb');
    const f  = document.getElementById('f');
    const clearBtn = document.getElementById('clear');

    function majorLabel(v){
      return v === 'SCI_MATH' ? 'วิทย์คณิต' :
             v === 'MATH_ENGLISH' ? 'คณิตอังกฤษ' : 'ทั่วไป';
    }

    async function load(){
      const res = await fetch(api);
      const list = await res.json();
      tb.innerHTML = '';
      list.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.id}</td>
          <td>${s.firstName}</td>
          <td>${s.lastName}</td>
          <td><span class="chip">${majorLabel(s.major)}</span></td>
          <td>${s.level}</td>
          <td>${Number(s.grade).toFixed(2)}</td>
          <td class="actions">
            <button class="btn secondary" onclick='edit(${JSON.stringify(s).replace(/"/g,"&quot;")})'>แก้ไข</button>
            <button class="btn" style="background:#e53935" onclick='del(${s.id})'>ลบ</button>
          </td>`;
        tb.appendChild(tr);
      });
    }

    function edit(s){
      document.getElementById('id').value = s.id;
      firstName.value = s.firstName;
      lastName.value  = s.lastName;
      major.value     = s.major;
      grade.value     = s.grade;
      level.value     = 'ม.4';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function del(id){
      if(!confirm('ลบรายการ #' + id + ' ?')) return;
      await fetch(`${api}/${id}`, { method: 'DELETE' });
      load();
    }

    f.addEventListener('submit', async e => {
      e.preventDefault();
      const payload = {
        firstName: firstName.value.trim(),
        lastName:  lastName.value.trim(),
        major:     major.value,
        grade:     parseFloat(grade.value),
        level:     'ม.4'
      };
      if(!payload.major){ alert('กรุณาเลือกสาขา'); return; }
      if(isNaN(payload.grade) || payload.grade < 0 || payload.grade > 4){
        alert('เกรดต้องอยู่ระหว่าง 0.00 ถึง 4.00'); return;
      }
      const id = document.getElementById('id').value;
      const url = id ? `${api}/${id}` : api;
      const method = id ? 'PUT' : 'POST';

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });

      if(!res.ok){
        const msg = await res.text();
        alert('ผิดพลาด: ' + msg);
        return;
      }
      f.reset();
      level.value = 'ม.4';
      load();
    });

    clearBtn.onclick = () => { f.reset(); level.value='ม.4'; document.getElementById('id').value=''; };
    load();
  </script>
</body>
</html>
